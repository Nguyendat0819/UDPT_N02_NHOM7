events {
    worker_connections 1024;
}

http {

    # --- [BẢO VỆ 1] KHỞI TẠO BỘ CHỐNG SPAM (Rate Limiting) ---
    # Tạo vùng nhớ tên 'anti_spam', giới hạn mỗi IP chỉ được gửi 10 yêu cầu/giây
    limit_req_zone $binary_remote_addr zone=anti_spam:10m rate=10r/s;
    upstream spring_boot {
        ip_hash;
        # Trỏ về máy tính thật của bạn (nơi đang chạy VS Code)
        server host.docker.internal:8080;
        # Server 2 (Máy phụ - Bạn cần chạy thêm cái này)
        server host.docker.internal:8081;
    }

    server {
        listen 80;
        server_name localhost;
        # --- [BẢO VỆ 2] GIẤU THÔNG TIN ---
        # Tắt hiển thị phiên bản Nginx để Hacker không biết bạn dùng bản cũ hay mới
        server_tokens off;

        # --- [BẢO VỆ 3] GIỚI HẠN DỮ LIỆU ---
        # Chỉ cho phép gửi dữ liệu (ảnh/file) tối đa 10MB. Gửi to hơn sẽ bị chặn (Lỗi 413)
        client_max_body_size 10M;

        # --- [BẢO VỆ 4] HEADER BẢO MẬT (Chống tấn công trình duyệt) ---
        # Chống Clickjacking (Không cho trang khác nhúng web bạn vào iframe)
        add_header X-Frame-Options "SAMEORIGIN";
        # Chống XSS (Mã độc chèn vào trình duyệt)
        add_header X-XSS-Protection "1; mode=block";
        # Chống Sniffing (Ép trình duyệt tuân thủ định dạng file)
        add_header X-Content-Type-Options "nosniff";
        location / {
            # --- [KÍCH HOẠT BẢO VỆ SPAM] ---
            # Áp dụng luật 'anti_spam' cho đường dẫn này.
            # burst=20: Cho phép user "lỡ tay" F5 nhanh tối đa 20 cái (để không bị chặn nhầm)
            limit_req zone=anti_spam burst=20 nodelay;
            proxy_pass http://spring_boot;
            
            # Cấu hình bắt buộc cho WebSocket Chat
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            # (Tùy chọn) Thêm header này để Backend biết IP thật của người dùng
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}