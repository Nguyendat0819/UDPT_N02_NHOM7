version: '3.8'

services:
  # --- 1. POSTGRESQL MASTER (Ghi dữ liệu) ---
  postgres-db:
    image: postgres:15
    container_name: postgres-db
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "123"
      POSTGRES_DB: userChat
      POSTGRES_HOST_AUTH_METHOD: trust
    # Cấu hình Master để cho phép Replication
    command: |
      postgres 
      -c wal_level=replica 
      -c hot_standby=on 
      -c max_wal_senders=10 
      -c max_replication_slots=10 
      -c hot_standby_feedback=on
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      # Nạp file tạo user replication vào
      - ./init-master.sql:/docker-entrypoint-initdb.d/init-master.sql
    networks:
      - chat-network
    restart: always

  # --- 2. POSTGRESQL SLAVE (Backup dự phòng) ---
  postgres-slave:
    image: postgres:15
    container_name: postgres-slave
    ports:
      - "5434:5432"
    environment:
      PGPASSWORD: repl_password # Mật khẩu của user replication
    # Script tự động: Chờ Master dậy -> Xóa data cũ -> Copy data mới từ Master
    command: >
      bash -c "
      until pg_isready -h postgres-db -p 5432; do echo 'Cho Master khoi dong...'; sleep 2; done;
      if [ ! -f /var/lib/postgresql/data/standby.signal ]; then
        echo 'Dang sao chep du lieu tu Master...';
        rm -rf /var/lib/postgresql/data/*;
        pg_basebackup -h postgres-db -U repl_user -p 5432 -D /var/lib/postgresql/data -Fp -Xs -P -R;
      fi;
      docker-entrypoint.sh postgres"
    volumes:
      - postgres_slave_data:/var/lib/postgresql/data
    networks:
      - chat-network
    depends_on:
      - postgres-db
    restart: always

  # --- 3. NGINX ---
  nginx:
    image: nginx:alpine
    container_name: chat-gateway
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - chat-network

  # --- 4. REDIS ---
  redis:
    image: redis:alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    networks:
      - chat-network
    restart: always

  # ==========================================
  # === HỆ THỐNG MONGODB (GIỮ NGUYÊN) ===
  # ==========================================
  mongo-config:
    image: mongo:latest
    container_name: mongo-config
    command: mongod --configsvr --replSet rs-config --port 27019 --bind_ip_all
    ports:
      - "27019:27019"
    volumes:
      - mongo_config_data:/data/db
    networks:
      - chat-network

  mongo-shard1-a:
    image: mongo:latest
    container_name: mongo-shard1-a
    command: mongod --shardsvr --replSet rs-shard1 --port 27018 --bind_ip_all
    ports:
      - "27018:27018"
    volumes:
      - mongo_shard1_data:/data/db
    networks:
      - chat-network

  mongo-shard1-b:
    image: mongo:latest
    container_name: mongo-shard1-b
    command: mongod --shardsvr --replSet rs-shard1 --port 27018 --bind_ip_all
    volumes:
      - mongo_shard2_data:/data/db
    networks:
      - chat-network

  mongo-shard1-arbiter:
    image: mongo:latest
    container_name: mongo-shard1-arbiter
    command: mongod --shardsvr --replSet rs-shard1 --port 27018 --bind_ip_all
    networks:
      - chat-network

  mongo-router:
    image: mongo:latest
    container_name: mongo-router
    command: mongos --configdb rs-config/mongo-config:27019 --bind_ip_all --port 27017
    ports:
      - "27017:27017"
    networks:
      - chat-network
    depends_on:
      - mongo-config
      - mongo-shard1-a

# --- MẠNG VÀ VOLUME ---
networks:
  chat-network:
    driver: bridge

volumes:
  postgres_master_data:
  postgres_slave_data:
  mongo_config_data:
  mongo_shard1_data:
  mongo_shard2_data: